<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PulseFocus </title>
  <meta name="theme-color" content="#071022">
  <style>
    :root{
      --bg:#071022; --accent-1:#7c3aed; --accent-2:#5b21b6; --glass: rgba(255,255,255,0.04);
      --muted: #9fb0c8; --text:#e6eef8; --card-radius:18px; --shadow: 0 12px 40px rgba(2,6,23,0.6);
      --gap:14px; --max-width:980px;
      --tap-size:52px; /* accessible touch target */
    }

    /* Base reset */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;color:var(--text);-webkit-font-smoothing:antialiased}
    body{background: radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,0.12), transparent), linear-gradient(180deg,#041026 0%,var(--bg) 100%);display:flex;align-items:center;justify-content:center;padding:18px}

    /* Card layout */
    .card{width:100%;max-width:var(--max-width);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--card-radius);padding:18px;box-shadow:var(--shadow);display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start;backdrop-filter: blur(6px) saturate(140%);-webkit-backdrop-filter: blur(6px) saturate(140%);border:1px solid rgba(255,255,255,0.04)}

    /* Pour un timer parfaitement rond et sans carré autour */
    .timer-wrap {
      background: transparent !important;
      box-shadow: none !important;
      border: none !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
    }

    /* Supprime aussi le fond du cercle SVG si besoin */
    .timer-wrap svg circle[fill] {
      fill: none !important;
    }

    .card {
      background: none !important;
      box-shadow: none !important;
      border: none !important;
    }

    header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));box-shadow:0 6px 18px rgba(92,33,182,0.18)}
    h1{font-size:18px;margin:0;font-weight:600}
    small{color:var(--muted)}

    /* Left: Timer */
    .left{display:flex;flex-direction:column;align-items:center;padding:10px;background: transparent !important;box-shadow: none !important;border: none !important;}
    .timer-wrap{position:relative;width:340px;height:340px;border-radius:50%;display:grid;place-items:center;background:transparent !important;box-shadow:none !important;border:none !important;overflow:visible}
    svg{transform:rotate(-90deg);width:100%;height:100%}
    .time{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:auto}
    .minutes{font-size:54px;font-weight:700;letter-spacing:0.6px}

    /* Animation du cercle de timer : effet néon pulsant + glow dynamique */
    #progress {
      transition: stroke-dashoffset 0.7s cubic-bezier(.7,0,.3,1), stroke 0.4s, filter 0.5s;
      filter: drop-shadow(0 0 24px var(--accent-1)) drop-shadow(0 0 48px var(--accent-2)) brightness(1.2);
      will-change: stroke-dashoffset, filter;
      stroke-width: 14;
      stroke-linecap: round;
      animation: neon-glow 2.2s infinite alternate cubic-bezier(.7,0,.3,1);
    }
    @keyframes neon-glow {
      0%   { filter: drop-shadow(0 0 24px var(--accent-1)) drop-shadow(0 0 48px var(--accent-2)) brightness(1.2);}
      50%  { filter: drop-shadow(0 0 40px #fff) drop-shadow(0 0 80px var(--accent-1)) brightness(1.5);}
      100% { filter: drop-shadow(0 0 24px var(--accent-1)) drop-shadow(0 0 48px var(--accent-2)) brightness(1.2);}
    }
    /* Effet de flash quand un tour se termine */
    .timer-flash {
      animation: timer-flash 0.7s cubic-bezier(.7,0,.3,1);
    }
    @keyframes timer-flash {
      0% { filter: drop-shadow(0 0 64px #fff) brightness(2.2); }
      60% { filter: drop-shadow(0 0 0px #fff) brightness(1); }
      100% { filter: none; }
    }

    /* Désactive l'animation du nombre central */
    .minutes,
    .minutes.animated {
      animation: none !important;
      transition: none !important;
    }

    .label{color:var(--muted);margin-top:8px}

    /* Controls: large tappable buttons */
    .controls{display:flex;gap:8px;margin-top:18px;flex-wrap:wrap;justify-content:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:38px;height:38px;padding:0 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);cursor:pointer;font-weight:700;font-size:15px;box-sizing:border-box}
    .btn.primary{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));border:none;color:white;box-shadow:0 4px 12px rgba(124,58,237,0.12)}
    .btn.icon{width:38px;height:38px;padding:0;border-radius:10px}

    /* Right: settings */
    .right{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.03);backdrop-filter: blur(8px)}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field-row{display:flex;gap:10px}
    label{font-size:13px;color:var(--muted)}
    input[type=number], select, input[type=text]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}

    .toggles{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .toggle{display:flex;align-items:center;gap:10px}
    .small{font-size:13px;color:var(--muted)}

    .progress-bar{width:100%;height:12px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
    .progress-inner{height:100%;width:0%;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));transition:width 400ms ease}

    .badge-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .badge{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:999px;font-size:13px;color:var(--muted)}

    footer{grid-column:1/-1;margin-top:10px;color:var(--muted);font-size:13px;text-align:center}

    /* Floating bottom sheet for mobile settings */
    .mobile-sheet{display:none}
    .sheet-toggle{display:none}

    /* Micro interactions */
    .pulse{animation:pulse 1.6s infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}

    /* Responsive mobile-first adjustments */
    @media (max-width:920px){
      .card{grid-template-columns:1fr;padding:12px;gap:12px;min-height:100vh}
      .timer-wrap{width:84vw;height:84vw;max-width:320px;max-height:320px;border-radius:50%;background:transparent !important;box-shadow:none !important;border:none !important}
      .right{display:none} /* hide right column, use sheet */
      .sheet-toggle{display:flex;position:fixed;right:18px;bottom:20px;z-index:60}
      .sheet-toggle .btn{border-radius:999px;padding:14px 16px}
      .mobile-sheet{display:block;position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg, rgba(8,10,20,0.98), rgba(8,10,20,0.99));border-top-left-radius:18px;border-top-right-radius:18px;padding:12px;box-shadow:0 -8px 30px rgba(2,6,23,0.6);transform:translateY(100%);transition:transform 320ms cubic-bezier(.2,.9,.3,1);z-index:59;max-height:90vh;overflow-y:auto}
      .mobile-sheet.open{transform:translateY(0%)}
      .sheet-handle{width:36px;height:4px;border-radius:999px;background:rgba(255,255,255,0.06);margin:6px auto}
      .controls{gap:10px}
    }

    @media (max-width:420px){
      .timer-wrap{width:76vw;height:76vw;border-radius:50%;background:transparent !important;box-shadow:none !important;border:none !important}
      .minutes{font-size:38px}
      .btn{min-width:32px;height:32px;font-size:13px}
      .btn.icon{min-width:32px;height:32px;font-size:13px}
    }

    #todo-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 8px 12px;
      margin-bottom: 6px;
      color: var(--text);
      font-size: 15px;
      transition: background 0.2s;
    }
    #todo-list li.done {
      text-decoration: line-through;
      color: #9fb0c8;
      opacity: 0.7;
    }
    .todo-actions {
      display: flex;
      gap: 6px;
    }
    .todo-link {
      background: none;
      border: none;
      color: var(--accent-1);
      cursor: pointer;
      font-size: 15px;
      padding: 2px 6px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .todo-link:hover {
      background: rgba(124,58,237,0.08);
    }

    @media (max-width:920px){
      .sheet-toggle {
        display: flex;
        position: fixed;
        left: 50%;
        bottom: 28px;
        transform: translateX(-50%);
        z-index: 60;
        justify-content: center;
        align-items: center;
      }
      .sheet-toggle .btn {
        border-radius: 999px;
        padding: 8px 22px;
        font-size: 18px;
        box-shadow: 0 4px 14px #7c3aed33;
        min-width: 60px;
        min-height: 38px;
        height: 38px;
        width: auto;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }
  </style>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <div class="card" role="application" aria-label="PulseFocus">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="44" height="44" viewBox="0 0 44 44" fill="none">
            <circle cx="22" cy="22" r="22" fill="#7c3aed"/>
            <ellipse cx="22" cy="30" rx="10" ry="6" fill="#fff" opacity="0.18"/>
            <circle cx="22" cy="18" r="8" fill="#fff"/>
            <circle cx="22" cy="18" r="4" fill="#7c3aed"/>
          </svg>
        </div>
        <div>
          <h1>PulseFocus</h1>
        
        </div>
      </div>
      <div class="small">Sessions : <strong id="ui-sessions">0</strong></div>
    </header>

    <section class="left">
      <div class="timer-wrap" role="region" aria-label="Timer principal">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <circle cx="50" cy="50" r="44" fill="none" stroke="rgba(255,255,255,0.04)" stroke-width="12" />
          <circle id="progress" cx="50" cy="50" r="44" fill="none" stroke="url(#grad)" stroke-width="12" stroke-linecap="round" stroke-dasharray="276.46" stroke-dashoffset="0" />
          <defs>
            <linearGradient id="grad" x1="0%" y1="0%" x2="100%">
              <stop offset="0%" stop-color="var(--accent-1)" />
              <stop offset="100%" stop-color="var(--accent-2)" />
            </linearGradient>
          </defs>
        </svg>

        <div class="time">
          <div class="minutes" id="time-display">25:00</div>
          <div class="label" id="phase-label">Travail • Focus</div>
          <div class="controls" role="toolbar" aria-label="Contrôles">
            <button id="start-btn" class="btn primary pulse" aria-pressed="false">Start</button>
            <button id="pause-btn" class="btn">Pause</button>
            <button id="reset-btn" class="btn">Reset</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center;width:100%">
        <input id="task-input" placeholder="Tâche du focus (optionnel)" aria-label="Tâche du focus" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)" />
        <button id="save-task" class="btn">Save</button>
      </div>

      <div id="google-tasks-connect" style="margin-bottom:10px;text-align:center">
        <button id="google-auth-btn" class="btn" style="background:#fff;color:#7c3aed;border:1px solid #7c3aed">Synchroniser Google Calendar</button>
        <span id="google-auth-status" class="small" style="margin-left:8px"></span>
      </div>

      <div id="todo-section" style="width:100%;margin-top:10px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="todo-input" type="text" placeholder="Nouvelle tâche à faire..." style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)" />
          <button id="add-todo" class="btn" title="Ajouter la tâche">+</button>
        </div>
        <ul id="todo-list" style="list-style:none;padding:0;margin:10px 0 0 0;"></ul>
      </div>

      <div style="width:100%;margin-top:12px">
        <div class="progress-bar" aria-hidden="true"><div id="daily-progress" class="progress-inner"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px"><div class="small">Objectif aujourd'hui (min)</div><div id="daily-target-label">0 / 0</div></div>
      </div>
    </section>

    <!-- Desktop settings column -->
    <aside class="right" id="desktop-settings">
      <div class="field two-cols">
        <div>
          <label for="work-min">Travail (min)</label>
          <input id="work-min" type="number" min="1" value="25" />
        </div>
        <div>
          <label for="short-min">Pause courte</label>
          <input id="short-min" type="number" min="1" value="5" />
        </div>
      </div>

      <div class="field two-cols">
        <div>
          <label for="long-min">Pause longue</label>
          <input id="long-min" type="number" min="1" value="15" />
        </div>
        <div>
          <label for="cycles">Cycles</label>
          <input id="cycles" type="number" min="1" value="4" />
        </div>
      </div>

      <div class="field">
        <label for="goal-min">Objectif (min)</label>
        <input id="goal-min" type="number" min="0" value="50" />
      </div>

      <div class="toggles">
        <label class="toggle"><input id="auto-next" type="checkbox" checked /> <span class="small">Démarrer automatiquement</span></label>
        <label class="toggle"><input id="sound" type="checkbox" checked /> <span class="small">Son à la fin</span></label>
        <label class="toggle"><input id="vibrate" type="checkbox" checked /> <span class="small">Vibration (mobile)</span></label>
        <label class="toggle"><input id="notify" type="checkbox" /> <span class="small">Notifications système</span></label>
      </div>

      <div class="toggles">
        <label class="toggle">
          <input id="block-notif" type="checkbox" />
          <span class="small">Bloquer toutes les notifications</span>
        </label>
      </div>

      <div style="margin-top:10px" class="field">
        <label for="ambience">Fond sonore</label>
        <select id="ambience">
          <option value="none">Aucun</option>
          <option value="rain">Pluie</option>
          <option value="white">Bruit blanc</option>
          <option value="fire">Feu de cheminée</option>
        </select>
      </div>

      <div class="stats" style="margin-top:12px">
        <div class="stat-item"><div class="small">Sessions aujourd'hui</div><div id="stat-today">0</div></div>
        <div class="stat-item"><div class="small">Sessions totales</div><div id="stat-total">0</div></div>
        <div class="stat-item"><div class="small">Minutes concentrées</div><div id="stat-minutes">0</div></div>
      </div>

      <div style="margin-top:12px" class="footer-actions">
        <button id="clear-stats" class="btn">Réinitialiser stats</button>
        <button id="export-stats" class="btn">Exporter</button>
      </div>

      <div style="margin-top:12px">
        <div class="small">Badges</div>
        <div id="badges" class="badge-list" aria-live="polite"></div>
      </div>
    </aside>

    <footer>Astuce : appuie sur <kbd>Space</kbd> pour démarrer/pause</footer>
  </div>

  <!-- Mobile sheet (hidden on desktop) -->
  <div class="sheet-toggle" id="sheet-toggle" aria-hidden="true">
    <button id="open-sheet" class="btn primary">⚙︎</button>
  </div>
  <div class="mobile-sheet" id="mobile-sheet" role="dialog" aria-label="Paramètres">
    <div class="sheet-handle"></div>
    <div style="padding:6px 10px;display:grid;gap:8px">
      <div class="field two-cols">
        <div><label for="work-min-m">Travail</label><input id="work-min-m" type="number" min="1" value="25"/></div>
        <div><label for="short-min-m">Pause</label><input id="short-min-m" type="number" min="1" value="5"/></div>
      </div>
      <div class="field two-cols">
        <div><label for="long-min-m">Pause longue</label><input id="long-min-m" type="number" min="1" value="15"/></div>
        <div><label for="cycles-m">Cycles</label><input id="cycles-m" type="number" min="1" value="4"/></div>
      </div>
      <div class="field">
        <label for="goal-min-m">Objectif (min)</label>
        <input id="goal-min-m" type="number" min="0" value="50" />
      </div>
      <div class="toggles">
        <label class="toggle"><input id="auto-next-m" type="checkbox" checked /> <span class="small">Auto démarrage</span></label>
        <label class="toggle"><input id="sound-m" type="checkbox" checked /> <span class="small">Son</span></label>
        <label class="toggle"><input id="vibrate-m" type="checkbox" checked /> <span class="small">Vibreur</span></label>
        <label class="toggle"><input id="notify-m" type="checkbox" /> <span class="small">Notifications système</span></label>
        <label class="toggle"><input id="block-notif-m" type="checkbox" /> <span class="small">Bloquer toutes les notifications</span></label>
      </div>
      <div class="field">
        <label for="ambience-m">Fond sonore</label>
        <select id="ambience-m">
          <option value="none">Aucun</option>
          <option value="rain">Pluie</option>
          <option value="white">Bruit blanc</option>
          <option value="fire">Feu de cheminée</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="apply-sheet" class="btn primary" style="flex:1">Appliquer</button>
        <button id="close-sheet" class="btn" style="flex:1">Fermer</button>
      </div>
      <div class="stats" style="margin-top:12px">
        <div class="stat-item"><div class="small">Sessions aujourd'hui</div><div id="stat-today-m">0</div></div>
        <div class="stat-item"><div class="small">Sessions totales</div><div id="stat-total-m">0</div></div>
        <div class="stat-item"><div class="small">Minutes concentrées</div><div id="stat-minutes-m">0</div></div>
      </div>
      <div style="margin-top:12px">
        <div class="small">Badges</div>
        <div id="badges-m" class="badge-list" aria-live="polite"></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="clear-stats-m" class="btn">Réinitialiser stats</button>
        <button id="export-stats-m" class="btn">Exporter</button>
      </div>
    </div>
  </div>

  <script>
    // ======= Utilitaires ========
    const $ = id => document.getElementById(id);
    const toMMSS = s => { const m = Math.floor(s/60).toString().padStart(2,'0'); const sec = Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${sec}`; };

    // ======= DOM refs ========
    const ui = { timeDisplay: $('time-display'), phaseLabel: $('phase-label'), startBtn: $('start-btn'), pauseBtn: $('pause-btn'), resetBtn: $('reset-btn'), progress: $('progress'), sessionsCounter: $('ui-sessions') };

    // ======= Settings & State ========
    let settings = { work: Number($('work-min').value) * 60, short: Number($('short-min').value) * 60, long: Number($('long-min').value) * 60, cyclesBeforeLong: Number($('cycles').value), autoNext: $('auto-next').checked, sound: $('sound').checked, vibrate: $('vibrate').checked, notify: $('notify').checked };
    let state = { running:false, phase:'work', remaining: settings.work, cycleCount:0, timerId:null };

    const R = 44; const C = 2*Math.PI*R; ui.progress.style.strokeDasharray = C;

    // ======= Storage & stats ========
    const STORAGE_KEY = 'pomodoro_focus_v3';
    const defaultStats = { sessionsToday:0, totalSessions:0, minutesFocused:0, todayDate:new Date().toISOString().slice(0,10), badges:[] };
    function loadStats(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return {...defaultStats}; const s = JSON.parse(raw); const today = new Date().toISOString().slice(0,10); if(s.todayDate !== today){ s.sessionsToday = 0; s.todayDate = today } return {...defaultStats, ...s}; }catch(e){ return {...defaultStats}; } }
    function saveStats(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
    let stats = loadStats();

    function renderStats(){ $('stat-today').textContent = stats.sessionsToday; $('stat-total').textContent = stats.totalSessions; $('stat-minutes').textContent = stats.minutesFocused; ui.sessionsCounter.textContent = stats.totalSessions; renderBadges(); updateDailyProgress(); }

    // ======= Badges ========
    const BADGE_DEFS = [ {id:'3-in-a-row', label:'3 sessions consécutives'}, {id:'10-sessions', label:'10 sessions'}, {id:'focused-100', label:'100 min concentré'} ];
    function renderBadges(){ const container = $('badges'); container.innerHTML = ''; stats.badges = stats.badges || []; BADGE_DEFS.forEach(b=>{ const owned = stats.badges.includes(b.id); const el = document.createElement('div'); el.className='badge'; el.textContent = owned ? `🏅 ${b.label}` : b.label; container.appendChild(el); }); }
    function grantBadge(id){ if(!stats.badges.includes(id)){ stats.badges.push(id); saveStats(stats); renderStats(); try{ navigator.vibrate && navigator.vibrate(200); }catch(e){} // gentle toast without blocking UI
      const toast = document.createElement('div'); toast.textContent = '🏅 '+BADGE_DEFS.find(b=>b.id===id).label; toast.style.position='fixed'; toast.style.left='50%'; toast.style.transform='translateX(-50%)'; toast.style.bottom='90px'; toast.style.background='rgba(0,0,0,0.6)'; toast.style.color='white'; toast.style.padding='10px 14px'; toast.style.borderRadius='999px'; toast.style.zIndex='999'; document.body.appendChild(toast); setTimeout(()=>toast.remove(), 2200);
    } }

    // ======= Ambience placeholders (replace assets for production) ========
    let ambienceAudio = null;
    function setAmbience(kind) {
      if (ambienceAudio) {
        ambienceAudio.pause();
        ambienceAudio = null;
      }
      if (kind === 'none') return;
      let url = '';
      if (kind === 'rain') url = 'https://www.youtube.com/watch?v=1M1V5gqbsG4'; // Pluie
      if (kind === 'white') url = 'https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae3e2.mp3'; // Bruit blanc (remplace par un vrai bruit blanc si tu veux)
      if (kind === 'fire') url = 'https://www.youtube.com/watch?v=v1cHHngnKBw'; // Feu de cheminée (remplace par un vrai feu si tu veux)
      if (!url) return;
      ambienceAudio = new Audio(url);
      ambienceAudio.loop = true;
      ambienceAudio.volume = 0.25;
      ambienceAudio.play().catch(()=>{});
    }

    // Synchronise le son d'ambiance avec le select (desktop)
    const ambienceSelect = document.getElementById('ambience');
    if (ambienceSelect) {
      ambienceSelect.addEventListener('change', e => {
        setAmbience(e.target.value);
      });
      // Lance le son si déjà sélectionné au chargement
      setAmbience(ambienceSelect.value);
    }

    // Synchronise le son d'ambiance avec le select mobile
    const ambienceSelectM = document.getElementById('ambience-m');
    if (ambienceSelectM) {
      ambienceSelectM.addEventListener('change', e => {
        setAmbience(e.target.value);
      });
    }

    // Arrête le son d'ambiance quand on ferme la feuille mobile si le son a changé
    if (document.getElementById('apply-sheet')) {
      document.getElementById('apply-sheet').addEventListener('click', () => {
        setAmbience(document.getElementById('ambience-m').value);
      });
    }
    if (document.getElementById('close-sheet')) {
      document.getElementById('close-sheet').addEventListener('click', () => {
        setAmbience(document.getElementById('ambience-m').value);
      });
    }

    // ======= Notifications & vibration ========
    async function notify(title, body){ if(!('Notification' in window)) return; if(Notification.permission === 'default'){ try{ await Notification.requestPermission(); }catch(e){} } if(Notification.permission === 'granted'){ try{ new Notification(title, { body }); }catch(e){} } }
    function vibrateIfAllowed(){ if(navigator.vibrate && (window.matchMedia && window.matchMedia('(any-pointer:coarse)').matches)) navigator.vibrate([200,100,200]); }

    // ======= Timer logic ========
    function setSettingsFromUI(){ settings.work = Math.max(1, Number($('work-min').value || 25)) * 60; settings.short = Math.max(1, Number($('short-min').value || 5)) * 60; settings.long = Math.max(1, Number($('long-min').value || 15)) * 60; settings.cyclesBeforeLong = Math.max(1, Number($('cycles').value || 4)); settings.autoNext = $('auto-next').checked; settings.sound = $('sound').checked; settings.vibrate = $('vibrate').checked; settings.notify = $('notify').checked; // update goal UI
      const goal = Number($('goal-min') ? $('goal-min').value : ($('goal-min-m') ? $('goal-min-m').value : 0)); if($('goal-min')) $('goal-min').value = goal; if($('goal-min-m')) $('goal-min-m').value = goal; updateDailyProgress(); }

    function startTimer(){ if(state.running) return; state.running = true; tick(); state.timerId = setInterval(tick,1000); ui.startBtn.classList.add('active'); ui.startBtn.setAttribute('aria-pressed','true'); ui.startBtn.textContent = 'Stop'; }
    function pauseTimer(){ state.running = false; if(state.timerId) clearInterval(state.timerId); state.timerId = null; ui.startBtn.classList.remove('active'); ui.startBtn.setAttribute('aria-pressed','false'); ui.startBtn.textContent = 'Start'; }
    function resetTimer(){ pauseTimer(); if(state.phase === 'work') state.remaining = settings.work; else if(state.phase === 'short') state.remaining = settings.short; else state.remaining = settings.long; renderTime(); }

    function nextPhase(){ if(state.phase === 'work'){ state.cycleCount++; stats.sessionsToday++; stats.totalSessions++; stats.minutesFocused += Math.round(settings.work/60); saveStats(stats); renderStats(); if(state.cycleCount % settings.cyclesBeforeLong === 0){ state.phase='long'; state.remaining = settings.long; } else { state.phase='short'; state.remaining = settings.short; } } else { state.phase='work'; state.remaining = settings.work; } ui.phaseLabel.textContent = phaseLabelText(); }
    function phaseLabelText(){ if(state.phase === 'work') return 'Travail • Focus'; if(state.phase === 'short') return 'Pause courte'; return 'Pause longue'; }

    function tick(){ if(!state.running) return; state.remaining -= 1; if(state.remaining <= 0){ pauseTimer(); if($('sound').checked) playBeep(); if($('vibrate').checked) vibrateIfAllowed(); if($('notify').checked) notify('Fin du temps', state.phase === 'work' ? 'Bravo — prends une pause !' : 'Retour au travail ?'); nextPhase(); renderTime(); checkAchievements(); if(settings.autoNext){ setTimeout(()=>startTimer(), 700); } return; } renderTime(); }

    function renderTime(){
      ui.timeDisplay.textContent = toMMSS(state.remaining);
      ui.phaseLabel.textContent = phaseLabelText();
      let total = (state.phase==='work')?settings.work:(state.phase==='short')?settings.short:settings.long;
      const fraction = (total - state.remaining)/total;
      const offset = Math.max(0, C * (1 - fraction));
      // Animation du cercle
      ui.progress.style.strokeDashoffset = offset;
      ui.progress.classList.remove('timer-flash');
      if(state.remaining === 0) {
        ui.progress.classList.add('timer-flash');
      }
      // Animation du nombre central supprimée
      ui.timeDisplay.classList.remove('animated');
    }

    // ======= Sound beep ========
    function playBeep(){ try{ const ctx = new (window.AudioContext || window.webkitAudioContext)(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.06; o.connect(g); g.connect(ctx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.6); o.stop(ctx.currentTime + 0.7); }catch(e){} }

    // ======= Achievements & Daily progress ========
    function updateDailyProgress(){ const dailyTarget = Math.max(0, Number($('goal-min') ? $('goal-min').value : ($('goal-min-m') ? $('goal-min-m').value : 0))); const minutes = stats.minutesFocused || 0; const percent = dailyTarget === 0 ? 0 : Math.min(100, Math.round((minutes / dailyTarget) * 100)); $('daily-progress').style.width = percent + '%'; $('daily-target-label').textContent = `${minutes} / ${dailyTarget}`; }
    function checkAchievements(){ if(stats.sessionsToday >= 3) grantBadge('3-in-a-row'); if(stats.totalSessions >= 10) grantBadge('10-sessions'); if(stats.minutesFocused >= 100) grantBadge('focused-100'); updateDailyProgress(); }

    // ======= Events wiring ========
    ui.startBtn.addEventListener('click', ()=>{ setSettingsFromUI(); if(state.running) pauseTimer(); else startTimer(); });
    ui.pauseBtn.addEventListener('click', ()=>{ pauseTimer(); });
    ui.resetBtn.addEventListener('click', ()=>{ setSettingsFromUI(); resetTimer(); });

    document.addEventListener('keydown', e=>{ if(e.code === 'Space'){ e.preventDefault(); if(state.running) pauseTimer(); else { setSettingsFromUI(); startTimer(); } } });

    ['work-min','short-min','long-min','cycles','goal-min'].forEach(id=>{ const el = $(id); if(el) el.addEventListener('change', ()=>{ setSettingsFromUI(); resetTimer(); renderStats(); }); });

    // Mobile sheet behavior: sync fields and apply
    const openSheetBtn = $('open-sheet'); const mobileSheet = $('mobile-sheet');
    if(openSheetBtn){ openSheetBtn.addEventListener('click', ()=>{ // copy current settings
        $('work-min-m').value = $('work-min').value; $('short-min-m').value = $('short-min').value; $('long-min-m').value = $('long-min').value; $('cycles-m').value = $('cycles').value; $('goal-min-m').value = $('goal-min').value; $('auto-next-m').checked = $('auto-next').checked; $('sound-m').checked = $('sound').checked; $('vibrate-m').checked = $('vibrate').checked; $('notify-m').checked = $('notify').checked; $('block-notif-m').checked = $('block-notif').checked; $('ambience-m').value = $('ambience').value; mobileSheet.classList.add('open'); document.body.style.overflow='hidden'; }); }
    const closeSheetBtn = $('close-sheet'); if(closeSheetBtn){ closeSheetBtn.addEventListener('click', ()=>{ mobileSheet.classList.remove('open'); document.body.style.overflow='auto'; }); }
    const applySheetBtn = $('apply-sheet'); if(applySheetBtn){ applySheetBtn.addEventListener('click', ()=>{ // copy back
        $('work-min').value = $('work-min-m').value; $('short-min').value = $('short-min-m').value; $('long-min').value = $('long-min-m').value; $('cycles').value = $('cycles-m').value; $('goal-min').value = $('goal-min-m').value; $('auto-next').checked = $('auto-next-m').checked; $('sound').checked = $('sound-m').checked; $('vibrate').checked = $('vibrate-m').checked; $('notify').checked = $('notify-m').checked; $('block-notif').checked = $('block-notif-m').checked; $('ambience').value = $('ambience-m').value; setSettingsFromUI(); resetTimer(); mobileSheet.classList.remove('open'); document.body.style.overflow='auto'; renderStats(); }); }

    // other controls
    $('save-task').addEventListener('click', ()=>{ const t = $('task-input').value.trim(); if(t){ localStorage.setItem('pomodoro_last_task', t); try{ navigator.vibrate && navigator.vibrate(40); }catch(e){} const s = document.createElement('div'); s.textContent = 'Tâche enregistrée'; s.style.position='fixed'; s.style.left='50%'; s.style.transform='translateX(-50%)'; s.style.bottom='90px'; s.style.background='rgba(0,0,0,0.6)'; s.style.color='white'; s.style.padding='8px 12px'; s.style.borderRadius='999px'; s.style.zIndex='999'; document.body.appendChild(s); setTimeout(()=>s.remove(),1500); } });
    $('clear-stats').addEventListener('click', ()=>{ if(confirm('Réinitialiser les statistiques ?')){ stats = {...defaultStats, todayDate:new Date().toISOString().slice(0,10)}; saveStats(stats); renderStats(); } });
    $('export-stats').addEventListener('click', ()=>{ const data = JSON.stringify(stats, null, 2); const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'pomodoro-stats.json'; a.click(); URL.revokeObjectURL(url); });

    // ======= Fullscreen ========
    function toggleFullscreen(){ if(!document.fullscreenElement){ document.documentElement.requestFullscreen().catch(()=>{}); } else { document.exitFullscreen().catch(()=>{}); } }

    // ======= Init ========
    setSettingsFromUI(); state.phase = 'work'; state.remaining = settings.work; renderStats(); renderTime(); setInterval(()=>{ saveStats(stats); }, 2000); checkAchievements();

    // ensure mobile sheet toggle visible on touch devices
    (function(){ if(window.matchMedia && window.matchMedia('(max-width:920px)').matches){ const st = $('sheet-toggle'); if(st) st.style.display='flex'; } })();

    // --- Gestion des tâches à faire ---
    const todoInput = document.getElementById('todo-input');
    const addTodoBtn = document.getElementById('add-todo');
    const todoList = document.getElementById('todo-list');
    const TODO_KEY = 'pomodoro_todos_v1';

    function loadTodos() {
      try {
        return JSON.parse(localStorage.getItem(TODO_KEY)) || [];
      } catch (e) {
        return [];
      }
    }
    function saveTodos(todos) {
      localStorage.setItem(TODO_KEY, JSON.stringify(todos));
    }
    function renderTodos() {
      const todos = loadTodos();
      todoList.innerHTML = '';
      todos.forEach((todo, idx) => {
        const li = document.createElement('li');
        li.className = todo.done ? 'done' : '';
        li.innerHTML = `
          <span>${todo.text}</span>
          <div class="todo-actions">
            <button class="todo-link" title="Lier à la session" data-link="${idx}">⏱️</button>
            <button class="todo-link" title="Terminer" data-done="${idx}">✔️</button>
            <button class="todo-link" title="Supprimer" data-del="${idx}">🗑️</button>
          </div>
        `;
        todoList.appendChild(li);
      });
    }
    function addTodo(text) {
      if (!text.trim()) return;
      const todos = loadTodos();
      todos.push({ text: text.trim(), done: false });
      saveTodos(todos);
      renderTodos();
      todoInput.value = '';
    }
    todoInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') addTodo(todoInput.value);
    });
    addTodoBtn.addEventListener('click', () => addTodo(todoInput.value));
    todoList.addEventListener('click', e => {
      const todos = loadTodos();
      if (e.target.dataset.del !== undefined) {
        todos.splice(Number(e.target.dataset.del), 1);
        saveTodos(todos);
        renderTodos();
      }
      if (e.target.dataset.done !== undefined) {
        const idx = Number(e.target.dataset.done);
        todos[idx].done = !todos[idx].done;
        saveTodos(todos);
        renderTodos();
      }
      if (e.target.dataset.link !== undefined) {
        // Lier la tâche à la session Pomodoro en la mettant dans l'input de focus
        const idx = Number(e.target.dataset.link);
        document.getElementById('task-input').value = todos[idx].text;
        // Optionnel : feedback visuel
        e.target.textContent = "✅";
        setTimeout(() => { e.target.textContent = "⏱️"; }, 800);
      }
    });

    // Initialisation à l'ouverture
    renderTodos();

    // Fonctionnalité : Bloquer toutes les notifications de l'app
    let blockNotifications = false;
    const blockNotifCheckbox = document.getElementById('block-notif');
    if (blockNotifCheckbox) {
      blockNotifCheckbox.addEventListener('change', () => {
        blockNotifications = blockNotifCheckbox.checked;
        // Feedback visuel
        const s = document.createElement('div');
        s.textContent = blockNotifications ? 'Notifications bloquées' : 'Notifications autorisées';
        s.style.position = 'fixed';
        s.style.left = '50%';
        s.style.transform = 'translateX(-50%)';
        s.style.bottom = '90px';
        s.style.background = 'rgba(0,0,0,0.6)';
        s.style.color = 'white';
        s.style.padding = '8px 12px';
        s.style.borderRadius = '999px';
        s.style.zIndex = '999';
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 1500);
      });
    }

    // Patch la fonction notify pour respecter ce blocage
    const originalNotify = window.notify;
    window.notify = async function(title, body) {
      if (blockNotifications) return;
      return originalNotify.apply(this, arguments);
    };

    // Fermer la feuille mobile si on clique en dehors (mobile)
    document.addEventListener('mousedown', function(e) {
      const sheet = document.getElementById('mobile-sheet');
      if (!sheet) return;
      if (!sheet.classList.contains('open')) return;
      // On ferme si clic hors de la feuille ET hors du bouton d'ouverture
      if (!sheet.contains(e.target) && !document.getElementById('open-sheet').contains(e.target)) {
        sheet.classList.remove('open');
        document.body.style.overflow = 'auto';
      }
    });

    // Pour le tactile (mobile)
    document.addEventListener('touchstart', function(e) {
      const sheet = document.getElementById('mobile-sheet');
      if (!sheet) return;
      if (!sheet.classList.contains('open')) return;
      if (!sheet.contains(e.target) && !document.getElementById('open-sheet').contains(e.target)) {
        sheet.classList.remove('open');
        document.body.style.overflow='auto';
      }
    });

    // Masquer le bouton paramètres quand le menu mobile est ouvert
    const sheetToggle = document.getElementById('sheet-toggle');

    function updateSheetToggleVisibility() {
      if (mobileSheet.classList.contains('open')) {
        sheetToggle.style.display = 'none';
      } else {
        sheetToggle.style.display = '';
      }
    }

    // Sur ouverture/fermeture de la feuille mobile
    if (document.getElementById('open-sheet')) {
      document.getElementById('open-sheet').addEventListener('click', () => {
        setTimeout(updateSheetToggleVisibility, 10);
      });
    }
    if (document.getElementById('close-sheet')) {
      document.getElementById('close-sheet').addEventListener('click', () => {
        setTimeout(updateSheetToggleVisibility, 320);
      });
    }

    // Aussi sur fermeture par clic/touch hors feuille
    document.addEventListener('mousedown', function(e) {
      const sheet = document.getElementById('mobile-sheet');
      if (!sheet) return;
      if (!sheet.classList.contains('open')) return;
      if (!sheet.contains(e.target) && !document.getElementById('open-sheet').contains(e.target)) {
        sheet.classList.remove('open');
        document.body.style.overflow = 'auto';
        setTimeout(updateSheetToggleVisibility, 320);
      }
    });
    document.addEventListener('touchstart', function(e) {
      const sheet = document.getElementById('mobile-sheet');
      if (!sheet) return;
      if (!sheet.classList.contains('open')) return;
      if (!sheet.contains(e.target) && !document.getElementById('open-sheet').contains(e.target)) {
        sheet.classList.remove('open');
        document.body.style.overflow = 'auto';
        setTimeout(updateSheetToggleVisibility, 320);
      }
    });

    // Initialisation au chargement
    updateSheetToggleVisibility();

    // ======= Google Tasks Integration ========
    const CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com';
    const API_KEY = '';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest"];
    const SCOPES = "https://www.googleapis.com/auth/tasks.readonly";

    let googleTasksLoaded = false;

    function updateGoogleStatus(msg) {
      document.getElementById('google-auth-status').textContent = msg;
    }

    function appendGoogleTasks(tasks) {
      // Ajoute les tâches Google à la todo-list locale (lecture seule, pas de suppression locale)
      const todos = loadTodos();
      tasks.forEach(task => {
        if (task.title && !todos.some(t => t.text === task.title)) {
          todos.push({ text: "[Google] " + task.title, done: !!task.status && task.status === "completed" });
        }
      });
      saveTodos(todos);
      renderTodos();
    }

    function listGoogleTasks() {
      gapi.client.tasks.tasklists.list().then(function(resp) {
        const lists = resp.result.items;
        if (!lists || !lists.length) {
          updateGoogleStatus("Aucune liste trouvée.");
          return;
        }
        // Prend la première liste (par défaut)
        gapi.client.tasks.tasks.list({ tasklist: lists[0].id }).then(function(resp2) {
          const tasks = resp2.result.items || [];
          appendGoogleTasks(tasks);
          updateGoogleStatus("Tâches importées !");
        });
      });
    }

    function handleAuthClick() {
      gapi.auth2.getAuthInstance().signIn().then(() => {
        updateGoogleStatus("Connecté !");
        listGoogleTasks();
      });
    }

    function initGoogleTasks() {
      gapi.load('client:auth2', () => {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(() => {
          googleTasksLoaded = true;
          document.getElementById('google-auth-btn').disabled = false;
          updateGoogleStatus("Prêt à synchroniser.");
        });
      });
    }

    document.getElementById('google-auth-btn').addEventListener('click', () => {
      if (!googleTasksLoaded) {
        updateGoogleStatus("Chargement Google...");
        initGoogleTasks();
        setTimeout(() => handleAuthClick(), 1200);
      } else {
        handleAuthClick();
      }
    });

    // Synchronise les stats desktop <-> mobile
    function renderStatsMobile() {
      document.getElementById('stat-today-m').textContent = stats.sessionsToday;
      document.getElementById('stat-total-m').textContent = stats.totalSessions;
      document.getElementById('stat-minutes-m').textContent = stats.minutesFocused;
      // Badges
      const container = document.getElementById('badges-m');
      container.innerHTML = '';
      BADGE_DEFS.forEach(b => {
        const owned = stats.badges.includes(b.id);
        const el = document.createElement('div');
        el.className = 'badge';
        el.textContent = owned ? `🏅 ${b.label}` : b.label;
        container.appendChild(el);
      });
    }
    renderStatsMobile();
    setInterval(renderStatsMobile, 2000);

    // Actions stats mobile
    document.getElementById('clear-stats-m').addEventListener('click', () => {
      if(confirm('Réinitialiser les statistiques ?')) {
        stats = {...defaultStats, todayDate:new Date().toISOString().slice(0,10)};
        saveStats(stats);
        renderStats();
        renderStatsMobile();
      }
    });
    document.getElementById('export-stats-m').addEventListener('click', () => {
      const data = JSON.stringify(stats, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'pomodoro-stats.json';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>